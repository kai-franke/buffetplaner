<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buffet Planer</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FIREBASE CONFIG â€” Hier deine eigenen Werte eintragen!
     Anleitung am Ende der Datei.
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, set, push, remove, update, onValue, get }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const FIREBASE_CONFIG = {
    apiKey:            "AIzaSyCq_O8TEMF1Ah5N_4AJuMVPSMza6M0e8nw",
    authDomain:        "buffetplaner.firebaseapp.com",
    databaseURL:       "https://buffetplaner-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:         "buffetplaner",
    storageBucket:     "buffetplaner.firebasestorage.app",
    messagingSenderId: "492138106004",
    appId:             "1:492138106004:web:ccc47e1820f352d363b881"
  };

  // â”€â”€ Demo-Modus: Wenn Config nicht ausgefÃ¼llt, nutze localStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const DEMO_MODE = FIREBASE_CONFIG.apiKey === "DEIN_API_KEY";

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SEED DATA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const SEED = {
    dishes: {
      d1: { name: "Roastbeef",      sort: 0 },
      d2: { name: "Graved Lax",     sort: 1 },
      d3: { name: "Garnelenpfanne", sort: 2 },
    },
    components: {
      c1:  { dishId: "d1", name: "Braten",          ownerName: "Thomas", prepDay: "Do", sort: 0 },
      c2:  { dishId: "d1", name: "Remoulade",        ownerName: "Lisa",   prepDay: "Mi", sort: 1 },
      c3:  { dishId: "d1", name: "Bratkartoffeln",   ownerName: "Thomas", prepDay: "Do", sort: 2 },
      c4:  { dishId: "d2", name: "Lachs",            ownerName: "Maria",  prepDay: "Di", sort: 0 },
      c5:  { dishId: "d2", name: "Senf-Dill-Sauce",  ownerName: "Lisa",   prepDay: "Mi", sort: 1 },
      c6:  { dishId: "d3", name: "Pfanne",           ownerName: "",       prepDay: null, sort: 0 },
    },
    ingredients: {
      i1:  { compId: "c1", name: "Rinderbraten",  amount: 2,   unit: "kg",  note: "",      sort: 0 },
      i2:  { compId: "c1", name: "Salz",          amount: 30,  unit: "g",   note: "",      sort: 1 },
      i3:  { compId: "c1", name: "Pfeffer",       amount: 10,  unit: "g",   note: "",      sort: 2 },
      i4:  { compId: "c1", name: "OlivenÃ¶l",      amount: 50,  unit: "ml",  note: "",      sort: 3 },
      i5:  { compId: "c2", name: "Mayonnaise",    amount: 500, unit: "g",   note: "",      sort: 0 },
      i6:  { compId: "c2", name: "Cornichons",    amount: 200, unit: "g",   note: "",      sort: 1 },
      i7:  { compId: "c2", name: "Kapern",        amount: 50,  unit: "g",   note: "",      sort: 2 },
      i8:  { compId: "c3", name: "Kartoffeln",    amount: 3,   unit: "kg",  note: "",      sort: 0 },
      i9:  { compId: "c3", name: "Butter",        amount: 200, unit: "g",   note: "",      sort: 1 },
      i10: { compId: "c3", name: "Knoblauch",     amount: 100, unit: "g",   note: "",      sort: 2 },
      i11: { compId: "c4", name: "Lachsfilet",    amount: 2,   unit: "kg",  note: "",      sort: 0 },
      i12: { compId: "c4", name: "Salz",          amount: 100, unit: "g",   note: "",      sort: 1 },
      i13: { compId: "c4", name: "Zucker",        amount: 80,  unit: "g",   note: "",      sort: 2 },
      i14: { compId: "c4", name: "Dill",          amount: 1,   unit: "Stk", note: "Bund",  sort: 3 },
      i15: { compId: "c5", name: "Senf",          amount: 200, unit: "g",   note: "",      sort: 0 },
      i16: { compId: "c5", name: "Dill",          amount: 1,   unit: "Stk", note: "Bund",  sort: 1 },
      i17: { compId: "c5", name: "Honig",         amount: 30,  unit: "ml",  note: "",      sort: 2 },
      i18: { compId: "c5", name: "Zitronensaft",  amount: 20,  unit: "ml",  note: "",      sort: 3 },
      i19: { compId: "c6", name: "Garnelen",      amount: 1.5, unit: "kg",  note: "TK",    sort: 0 },
      i20: { compId: "c6", name: "Chili",         amount: 2,   unit: "Stk", note: "",      sort: 1 },
    },
    purchased: {}
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let state = { dishes: {}, components: {}, ingredients: {}, purchased: {} };
  let db = null;

  // â”€â”€ Demo-Storage (localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const LS_KEY = "buffet-planer-v2";
  function lsLoad() {
    try { const r = localStorage.getItem(LS_KEY); return r ? JSON.parse(r) : null; } catch { return null; }
  }
  function lsSave() {
    try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch {}
  }

  // â”€â”€ Snackbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let snackTimer = null;
  function snack(msg, undo = null) {
    const el = document.getElementById("snackbar");
    el.innerHTML = msg + (undo ? ` <button onclick="window._undoFn()">RÃ¼ckgÃ¤ngig</button>` : "");
    window._undoFn = undo;
    el.classList.add("show");
    clearTimeout(snackTimer);
    snackTimer = setTimeout(() => el.classList.remove("show"), 5000);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  FIREBASE / DEMO ABSTRACTION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function dbSet(path, val) {
    if (DEMO_MODE) {
      setPath(state, path, val);
      lsSave();
      render();
      return Promise.resolve();
    }
    return set(ref(db, path), val);
  }
  function dbPush(path, val) {
    if (DEMO_MODE) {
      const id = "k" + Date.now() + Math.random().toString(36).slice(2, 6);
      setPath(state, path + "/" + id, val);
      lsSave();
      render();
      return Promise.resolve(id);
    }
    return push(ref(db, path), val).then(r => r.key);
  }
  function dbUpdate(path, val) {
    if (DEMO_MODE) {
      const cur = getPath(state, path) || {};
      setPath(state, path, { ...cur, ...val });
      lsSave();
      render();
      return Promise.resolve();
    }
    return update(ref(db, path), val);
  }
  function dbRemove(path) {
    if (DEMO_MODE) {
      removePath(state, path);
      lsSave();
      render();
      return Promise.resolve();
    }
    return remove(ref(db, path));
  }

  function getPath(obj, path) {
    return path.split("/").filter(Boolean).reduce((o, k) => o && o[k], obj);
  }
  function setPath(obj, path, val) {
    const parts = path.split("/").filter(Boolean);
    let cur = obj;
    for (let i = 0; i < parts.length - 1; i++) {
      if (!cur[parts[i]]) cur[parts[i]] = {};
      cur = cur[parts[i]];
    }
    cur[parts[parts.length - 1]] = val;
  }
  function removePath(obj, path) {
    const parts = path.split("/").filter(Boolean);
    let cur = obj;
    for (let i = 0; i < parts.length - 1; i++) {
      if (!cur[parts[i]]) return;
      cur = cur[parts[i]];
    }
    delete cur[parts[parts.length - 1]];
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CRUD OPERATIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function nextSort(collection) {
    const items = Object.values(collection || {});
    return items.length ? Math.max(...items.map(i => i.sort || 0)) + 1 : 0;
  }

  async function addDish(name) {
    const sort = nextSort(state.dishes);
    await dbPush("dishes", { name, sort });
  }
  async function updateDish(id, patch) { await dbUpdate(`dishes/${id}`, patch); }
  async function deleteDish(id) {
    // cascade components + ingredients
    const comps = Object.entries(state.components || {}).filter(([, c]) => c.dishId === id);
    for (const [cid] of comps) await deleteComponent(cid, true);
    await dbRemove(`dishes/${id}`);
  }

  async function addComponent(dishId, name) {
    const sort = nextSort(state.components);
    await dbPush("components", { dishId, name, ownerName: "", prepDay: null, sort });
  }
  async function updateComponent(id, patch) { await dbUpdate(`components/${id}`, patch); }
  async function deleteComponent(id, cascade = false) {
    const ings = Object.entries(state.ingredients || {}).filter(([, i]) => i.compId === id);
    for (const [iid] of ings) await dbRemove(`ingredients/${iid}`);
    await dbRemove(`components/${id}`);
  }

  async function addIngredient(compId) {
    const sort = nextSort(state.ingredients);
    await dbPush("ingredients", { compId, name: "", amount: null, unit: "g", note: "", sort });
  }
  async function updateIngredient(id, patch) { await dbUpdate(`ingredients/${id}`, patch); }
  async function deleteIngredient(id) {
    const snap = state.ingredients[id];
    await dbRemove(`ingredients/${id}`);
    snack("Zutat gelÃ¶scht", async () => {
      await dbSet(`ingredients/${id}`, snap);
    });
  }

  async function togglePurchased(key) {
    const cur = (state.purchased || {})[key] || {};
    await dbUpdate(`purchased/${key}`, { bought: !cur.bought });
  }
  async function updateStock(key, stock) {
    await dbUpdate(`purchased/${key}`, { stock: stock === "" ? null : parseFloat(stock) });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  DERIVED DATA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function sortedDishes() {
    return Object.entries(state.dishes || {})
      .sort((a, b) => (a[1].sort || 0) - (b[1].sort || 0));
  }
  function componentsOfDish(dishId) {
    return Object.entries(state.components || {})
      .filter(([, c]) => c.dishId === dishId)
      .sort((a, b) => (a[1].sort || 0) - (b[1].sort || 0));
  }
  function ingredientsOfComp(compId) {
    return Object.entries(state.ingredients || {})
      .filter(([, i]) => i.compId === compId)
      .sort((a, b) => (a[1].sort || 0) - (b[1].sort || 0));
  }

  function shoppingList() {
    const map = {};
    for (const [, ing] of Object.entries(state.ingredients || {})) {
      if (!ing.name) continue;
      const key = ing.name.toLowerCase().trim() + "|" + (ing.unit || "");
      if (!map[key]) map[key] = { name: ing.name, unit: ing.unit || "", total: 0, notes: [] };
      map[key].total += parseFloat(ing.amount) || 0;
      if (ing.note) map[key].notes.push(ing.note);
    }
    return Object.entries(map).sort((a, b) => a[1].name.localeCompare(b[1].name, "de"));
  }

  function productionData(filterDay = null, filterOwner = null) {
    const days = ["Di", "Mi", "Do"];
    const result = {};
    for (const day of days) result[day] = [];

    for (const [cid, comp] of Object.entries(state.components || {})) {
      if (!comp.prepDay) continue;
      if (filterDay && comp.prepDay !== filterDay) continue;
      if (filterOwner && comp.ownerName !== filterOwner) continue;
      const dish = state.dishes?.[comp.dishId];
      const ings = ingredientsOfComp(cid);
      result[comp.prepDay].push({ cid, comp, dish, ings });
    }
    return result;
  }

  function allOwners() {
    const s = new Set();
    for (const c of Object.values(state.components || {})) if (c.ownerName) s.add(c.ownerName);
    return Array.from(s).sort();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let activeTab = "plan";
  let searchQuery = "";
  let prodFilterDay = "";
  let prodFilterOwner = "";
  let confirmPending = null;

  function render() {
    document.getElementById("app").innerHTML = buildApp();
    attachEvents();
  }

  const DAY_COLOR = { Di: "#3B82F6", Mi: "#059669", Do: "#D97706" };
  const DAY_BG    = { Di: "#EFF6FF", Mi: "#ECFDF5", Do: "#FFFBEB" };

  function buildApp() {
    return `
      <header>
        <div class="header-inner">
          <div class="logo">ğŸ½ï¸ <span>Buffet Planer</span></div>
          ${DEMO_MODE ? `<div class="demo-badge">Demo-Modus Â· Daten lokal</div>` : `<div class="demo-badge live">ğŸŸ¢ Live Â· Firebase</div>`}
        </div>
        <nav class="tabs">
          <button class="tab ${activeTab==='plan'?'active':''}" data-tab="plan">
            <svg viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            Plan
          </button>
          <button class="tab ${activeTab==='prod'?'active':''}" data-tab="prod">
            <svg viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            Produktion
          </button>
          <button class="tab ${activeTab==='shop'?'active':''}" data-tab="shop">
            <svg viewBox="0 0 24 24"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            Einkauf
          </button>
        </nav>
      </header>

      <main>
        ${activeTab === 'plan' ? buildPlan() : ''}
        ${activeTab === 'prod' ? buildProduction() : ''}
        ${activeTab === 'shop' ? buildShopping() : ''}
      </main>

      ${confirmPending ? buildConfirm() : ''}
    `;
  }

  // â”€â”€ Plan Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildPlan() {
    const dishes = sortedDishes();
    const q = searchQuery.toLowerCase();

    return `
      <div class="plan-toolbar">
        <div class="search-wrap">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          <input id="search" type="text" placeholder="Zutaten durchsuchenâ€¦" value="${escHtml(searchQuery)}">
        </div>
        <button class="btn-primary" id="add-dish">
          <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          Gericht
        </button>
      </div>

      <div class="board">
        ${dishes.map(([did, dish]) => buildDishBlock(did, dish, q)).join('')}
      </div>
    `;
  }

  function buildDishBlock(did, dish, q) {
    const comps = componentsOfDish(did);
    return `
      <div class="dish-block" data-did="${did}">
        <div class="dish-header">
          <svg class="chef-icon" viewBox="0 0 24 24"><path d="M12 2a4 4 0 014 4 4 4 0 01-1.16 2.77A6 6 0 0118 14v1H6v-1a6 6 0 013.16-5.23A4 4 0 018 6a4 4 0 014-4z"/><rect x="6" y="15" width="12" height="2" rx="1"/><rect x="8" y="17" width="8" height="3" rx="1"/></svg>
          <input class="dish-name-input" data-did="${did}" value="${escHtml(dish.name)}" placeholder="Gerichtname">
          <button class="icon-btn danger dish-delete" data-did="${did}" title="Gericht lÃ¶schen">
            <svg viewBox="0 0 24 24"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/></svg>
          </button>
        </div>
        <div class="components-row">
          ${comps.map(([cid, comp]) => buildComponentCard(cid, comp, q)).join('')}
          <div class="add-comp-col">
            <button class="btn-add-comp" data-did="${did}">
              <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
              Komponente
            </button>
          </div>
        </div>
      </div>
    `;
  }

  function buildComponentCard(cid, comp, q) {
    const ings = ingredientsOfComp(cid);
    const filtered = q ? ings.filter(([, i]) => i.name.toLowerCase().includes(q)) : ings;
    const highlight = q && filtered.length > 0;

    return `
      <div class="comp-card ${highlight ? 'highlighted' : ''}" data-cid="${cid}">
        <div class="comp-header">
          <input class="comp-name-input" data-cid="${cid}" value="${escHtml(comp.name)}" placeholder="Komponentenname">
          <button class="icon-btn danger comp-delete" data-cid="${cid}" title="Komponente lÃ¶schen">
            <svg viewBox="0 0 24 24"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/></svg>
          </button>
        </div>
        <div class="comp-meta">
          <input class="meta-input owner" data-cid="${cid}" placeholder="Verantwortlich" value="${escHtml(comp.ownerName || '')}">
          <select class="meta-select day-select" data-cid="${cid}">
            <option value="">â€” Tag â€”</option>
            ${['Di','Mi','Do'].map(d => `<option value="${d}" ${comp.prepDay===d?'selected':''}>${d}</option>`).join('')}
          </select>
          ${comp.prepDay ? `<span class="day-badge" style="background:${DAY_COLOR[comp.prepDay]}">${comp.prepDay}</span>` : ''}
        </div>
        <div class="ing-list">
          ${(q ? filtered : ings).map(([iid, ing]) => buildIngredientRow(iid, ing, q)).join('')}
        </div>
        <button class="btn-add-ing" data-cid="${cid}">
          <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          Zutat
        </button>
      </div>
    `;
  }

  function buildIngredientRow(iid, ing, q) {
    const nameHl = q && ing.name.toLowerCase().includes(q)
      ? ing.name.replace(new RegExp(q, 'gi'), m => `<mark>${m}</mark>`)
      : escHtml(ing.name);
    return `
      <div class="ing-row" data-iid="${iid}">
        <input class="ing-name" data-iid="${iid}" value="${escHtml(ing.name)}" placeholder="Zutatname">
        <input class="ing-amount" data-iid="${iid}" type="number" value="${ing.amount ?? ''}" placeholder="Menge" min="0" step="any">
        <select class="ing-unit" data-iid="${iid}">
          ${['g','kg','ml','l','Stk'].map(u => `<option ${ing.unit===u?'selected':''}>${u}</option>`).join('')}
        </select>
        <input class="ing-note" data-iid="${iid}" value="${escHtml(ing.note || '')}" placeholder="Notiz">
        <button class="icon-btn danger ing-delete" data-iid="${iid}">
          <svg viewBox="0 0 24 24"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/></svg>
        </button>
      </div>
    `;
  }

  // â”€â”€ Production Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildProduction() {
    const owners = allOwners();
    const data = productionData(prodFilterDay || null, prodFilterOwner || null);
    return `
      <div class="prod-filters">
        <select id="filter-day">
          <option value="">Alle Tage</option>
          ${['Di','Mi','Do'].map(d => `<option ${prodFilterDay===d?'selected':''}>${d}</option>`).join('')}
        </select>
        <select id="filter-owner">
          <option value="">Alle Personen</option>
          ${owners.map(o => `<option ${prodFilterOwner===o?'selected':''}>${o}</option>`).join('')}
        </select>
        <button class="btn-print" onclick="window.print()">
          <svg viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Drucken
        </button>
      </div>
      <div class="prod-board">
        ${['Di','Mi','Do'].map(day => {
          const items = data[day];
          if (!items.length && (prodFilterDay && prodFilterDay !== day)) return '';
          return `
            <div class="prod-day-col">
              <div class="prod-day-header" style="background:${DAY_COLOR[day]}">${day === 'Di' ? 'Dienstag' : day === 'Mi' ? 'Mittwoch' : 'Donnerstag'}</div>
              <div class="prod-cards">
                ${items.map(({ cid, comp, dish, ings }) => `
                  <div class="prod-card" style="border-left: 3px solid ${DAY_COLOR[comp.prepDay]}">
                    <div class="prod-card-head">
                      <strong>${escHtml(comp.name)}</strong>
                      <span class="temp-badge ${comp.warm ? 'warm' : 'kalt'}">${comp.war      d2: { name: "Graved Lax",     sort: 1 },
      d3: { name: "Garnelenpfanne", sort: 2 },
    },
    components: {
      c1:  { dishId: "d1", name: "Braten",          ownerName: "Thomas", prepDay: "Do", sort: 0 },
      c2:  { dishId: "d1", name: "Remoulade",        ownerName: "Lisa",   prepDay: "Mi", sort: 1 },
      c3:  { dishId: "d1", name: "Bratkartoffeln",   ownerName: "Thomas", prepDay: "Do", sort: 2 },
      c4:  { dishId: "d2", name: "Lachs",            ownerName: "Maria",  prepDay: "Di", sort: 0 },
      c5:  { dishId: "d2", name: "Senf-Dill-Sauce",  ownerName: "Lisa",   prepDay: "Mi", sort: 1 },
      c6:  { dishId: "d3", name: "Pfanne",           ownerName: "",       prepDay: null, sort: 0 },
    },
    ingredients: {
      i1:  { compId: "c1", name: "Rinderbraten",  amount: 2,   unit: "kg",  note: "",      sort: 0 },
      i2:  { compId: "c1", name: "Salz",          amount: 30,  unit: "g",   note: "",      sort: 1 },
      i3:  { compId: "c1", name: "Pfeffer",       amount: 10,  unit: "g",   note: "",      sort: 2 },
      i4:  { compId: "c1", name: "OlivenÃ¶l",      amount: 50,  unit: "ml",  note: "",      sort: 3 },
      i5:  { compId: "c2", name: "Mayonnaise",    amount: 500, unit: "g",   note: "",      sort: 0 },
      i6:  { compId: "c2", name: "Cornichons",    amount: 200, unit: "g",   note: "",      sort: 1 },
      i7:  { compId: "c2", name: "Kapern",        amount: 50,  unit: "g",   note: "",      sort: 2 },
      i8:  { compId: "c3", name: "Kartoffeln",    amount: 3,   unit: "kg",  note: "",      sort: 0 },
      i9:  { compId: "c3", name: "Butter",        amount: 200, unit: "g",   note: "",      sort: 1 },
      i10: { compId: "c3", name: "Knoblauch",     amount: 100, unit: "g",   note: "",      sort: 2 },
      i11: { compId: "c4", name: "Lachsfilet",    amount: 2,   unit: "kg",  note: "",      sort: 0 },
      i12: { compId: "c4", name: "Salz",          amount: 100, unit: "g",   note: "",      sort: 1 },
      i13: { compId: "c4", name: "Zucker",        amount: 80,  unit: "g",   note: "",      sort: 2 },
      i14: { compId: "c4", name: "Dill",          amount: 1,   unit: "Stk", note: "Bund",  sort: 3 },
      i15: { compId: "c5", name: "Senf",          amount: 200, unit: "g",   note: "",      sort: 0 },
      i16: { compId: "c5", name: "Dill",          amount: 1,   unit: "Stk", note: "Bund",  sort: 1 },
      i17: { compId: "c5", name: "Honig",         amount: 30,  unit: "ml",  note: "",      sort: 2 },
      i18: { compId: "c5", name: "Zitronensaft",  amount: 20,  unit: "ml",  note: "",      sort: 3 },
      i19: { compId: "c6", name: "Garnelen",      amount: 1.5, unit: "kg",  note: "TK",    sort: 0 },
      i20: { compId: "c6", name: "Chili",         amount: 2,   unit: "Stk", note: "",      sort: 1 },
    },
    purchased: {}
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let state = { dishes: {}, components: {}, ingredients: {}, purchased: {} };
  let db = null;

  // â”€â”€ Demo-Storage (localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const LS_KEY = "buffet-planer-v2";
  function lsLoad() {
    try { const r = localStorage.getItem(LS_KEY); return r ? JSON.parse(r) : null; } catch { return null; }
  }
  function lsSave() {
    try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch {}
  }

  // â”€â”€ Snackbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let snackTimer = null;
  function snack(msg, undo = null) {
    const el = document.getElementById("snackbar");
    el.innerHTML = msg + (undo ? ` <button onclick="window._undoFn()">RÃ¼ckgÃ¤ngig</button>` : "");
    window._undoFn = undo;
    el.classList.add("show");
    clearTimeout(snackTimer);
    snackTimer = setTimeout(() => el.classList.remove("show"), 5000);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  FIREBASE / DEMO ABSTRACTION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function dbSet(path, val) {
    if (DEMO_MODE) {
      setPath(state, path, val);
      lsSave();
      render();
      return Promise.resolve();
    }
    return set(ref(db, path), val);
  }
  function dbPush(path, val) {
    if (DEMO_MODE) {
      const id = "k" + Date.now() + Math.random().toString(36).slice(2, 6);
      setPath(state, path + "/" + id, val);
      lsSave();
      render();
      return Promise.resolve(id);
    }
    return push(ref(db, path), val).then(r => r.key);
  }
  function dbUpdate(path, val) {
    if (DEMO_MODE) {
      const cur = getPath(state, path) || {};
      setPath(state, path, { ...cur, ...val });
      lsSave();
      render();
      return Promise.resolve();
    }
    return update(ref(db, path), val);
  }
  function dbRemove(path) {
    if (DEMO_MODE) {
      removePath(state, path);
      lsSave();
      render();
      return Promise.resolve();
    }
    return remove(ref(db, path));
  }

  function getPath(obj, path) {
    return path.split("/").filter(Boolean).reduce((o, k) => o && o[k], obj);
  }
  function setPath(obj, path, val) {
    const parts = path.split("/").filter(Boolean);
    let cur = obj;
    for (let i = 0; i < parts.length - 1; i++) {
      if (!cur[parts[i]]) cur[parts[i]] = {};
      cur = cur[parts[i]];
    }
    cur[parts[parts.length - 1]] = val;
  }
  function removePath(obj, path) {
    const parts = path.split("/").filter(Boolean);
    let cur = obj;
    for (let i = 0; i < parts.length - 1; i++) {
      if (!cur[parts[i]]) return;
      cur = cur[parts[i]];
    }
    delete cur[parts[parts.length - 1]];
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CRUD OPERATIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function nextSort(collection) {
    const items = Object.values(collection || {});
    return items.length ? Math.max(...items.map(i => i.sort || 0)) + 1 : 0;
  }

  async function addDish(name) {
    const sort = nextSort(state.dishes);
    await dbPush("dishes", { name, sort });
  }
  async function updateDish(id, patch) { await dbUpdate(`dishes/${id}`, patch); }
  async function deleteDish(id) {
    // cascade components + ingredients
    const comps = Object.entries(state.components || {}).filter(([, c]) => c.dishId === id);
    for (const [cid] of comps) await deleteComponent(cid, true);
    await dbRemove(`dishes/${id}`);
  }

  async function addComponent(dishId, name) {
    const sort = nextSort(state.components);
    await dbPush("components", { dishId, name, ownerName: "", prepDay: null, sort });
  }
  async function updateComponent(id, patch) { await dbUpdate(`components/${id}`, patch); }
  async function deleteComponent(id, cascade = false) {
    const ings = Object.entries(state.ingredients || {}).filter(([, i]) => i.compId === id);
    for (const [iid] of ings) await dbRemove(`ingredients/${iid}`);
    await dbRemove(`components/${id}`);
  }

  async function addIngredient(compId) {
    const sort = nextSort(state.ingredients);
    await dbPush("ingredients", { compId, name: "", amount: null, unit: "g", note: "", sort });
  }
  async function updateIngredient(id, patch) { await dbUpdate(`ingredients/${id}`, patch); }
  async function deleteIngredient(id) {
    const snap = state.ingredients[id];
    await dbRemove(`ingredients/${id}`);
    snack("Zutat gelÃ¶scht", async () => {
      await dbSet(`ingredients/${id}`, snap);
    });
  }

  async function togglePurchased(key) {
    const cur = (state.purchased || {})[key] || {};
    await dbUpdate(`purchased/${key}`, { bought: !cur.bought });
  }
  async function updateStock(key, stock) {
    await dbUpdate(`purchased/${key}`, { stock: stock === "" ? null : parseFloat(stock) });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  DERIVED DATA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function sortedDishes() {
    return Object.entries(state.dishes || {})
      .sort((a, b) => (a[1].sort || 0) - (b[1].sort || 0));
  }
  function componentsOfDish(dishId) {
    return Object.entries(state.components || {})
      .filter(([, c]) => c.dishId === dishId)
      .sort((a, b) => (a[1].sort || 0) - (b[1].sort || 0));
  }
  function ingredientsOfComp(compId) {
    return Object.entries(state.ingredients || {})
      .filter(([, i]) => i.compId === compId)
      .sort((a, b) => (a[1].sort || 0) - (b[1].sort || 0));
  }

  function shoppingList() {
    const map = {};
    for (const [, ing] of Object.entries(state.ingredients || {})) {
      if (!ing.name) continue;
      const key = ing.name.toLowerCase().trim() + "|" + (ing.unit || "");
      if (!map[key]) map[key] = { name: ing.name, unit: ing.unit || "", total: 0, notes: [] };
      map[key].total += parseFloat(ing.amount) || 0;
      if (ing.note) map[key].notes.push(ing.note);
    }
    return Object.entries(map).sort((a, b) => a[1].name.localeCompare(b[1].name, "de"));
  }

  function productionData(filterDay = null, filterOwner = null) {
    const days = ["Di", "Mi", "Do"];
    const result = {};
    for (const day of days) result[day] = [];

    for (const [cid, comp] of Object.entries(state.components || {})) {
      if (!comp.prepDay) continue;
      if (filterDay && comp.prepDay !== filterDay) continue;
      if (filterOwner && comp.ownerName !== filterOwner) continue;
      const dish = state.dishes?.[comp.dishId];
      const ings = ingredientsOfComp(cid);
      result[comp.prepDay].push({ cid, comp, dish, ings });
    }
    return result;
  }

  function allOwners() {
    const s = new Set();
    for (const c of Object.values(state.components || {})) if (c.ownerName) s.add(c.ownerName);
    return Array.from(s).sort();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let activeTab = "plan";
  let searchQuery = "";
  let prodFilterDay = "";
  let prodFilterOwner = "";
  let confirmPending = null;

  function render() {
    document.getElementById("app").innerHTML = buildApp();
    attachEvents();
  }

  const DAY_COLOR = { Di: "#3B82F6", Mi: "#059669", Do: "#D97706" };
  const DAY_BG    = { Di: "#EFF6FF", Mi: "#ECFDF5", Do: "#FFFBEB" };

  function buildApp() {
    return `
      <header>
        <div class="header-inner">
          <div class="logo">ğŸ½ï¸ <span>Buffet Planer</span></div>
          ${DEMO_MODE ? `<div class="demo-badge">Demo-Modus Â· Daten lokal</div>` : `<div class="demo-badge live">ğŸŸ¢ Live Â· Firebase</div>`}
        </div>
        <nav class="tabs">
          <button class="tab ${activeTab==='plan'?'active':''}" data-tab="plan">
            <svg viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            Plan
          </button>
          <button class="tab ${activeTab==='prod'?'active':''}" data-tab="prod">
            <svg viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            Produktion
          </button>
          <button class="tab ${activeTab==='shop'?'active':''}" data-tab="shop">
            <svg viewBox="0 0 24 24"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            Einkauf
          </button>
        </nav>
      </header>

      <main>
        ${activeTab === 'plan' ? buildPlan() : ''}
        ${activeTab === 'prod' ? buildProduction() : ''}
        ${activeTab === 'shop' ? buildShopping() : ''}
      </main>

      ${confirmPending ? buildConfirm() : ''}
    `;
  }

  // â”€â”€ Plan Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildPlan() {
    const dishes = sortedDishes();
    const q = searchQuery.toLowerCase();

    return `
      <div class="plan-toolbar">
        <div class="search-wrap">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          <input id="search" type="text" placeholder="Zutaten durchsuchenâ€¦" value="${escHtml(searchQuery)}">
        </div>
        <button class="btn-primary" id="add-dish">
          <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          Gericht
        </button>
      </div>

      <div class="board">
        ${dishes.map(([did, dish]) => buildDishBlock(did, dish, q)).join('')}
      </div>
    `;
  }

  function buildDishBlock(did, dish, q) {
    const comps = componentsOfDish(did);
    return `
      <div class="dish-block" data-did="${did}">
        <div class="dish-header">
          <svg class="chef-icon" viewBox="0 0 24 24"><path d="M12 2a4 4 0 014 4 4 4 0 01-1.16 2.77A6 6 0 0118 14v1H6v-1a6 6 0 013.16-5.23A4 4 0 018 6a4 4 0 014-4z"/><rect x="6" y="15" width="12" height="2" rx="1"/><rect x="8" y="17" width="8" height="3" rx="1"/></svg>
          <input class="dish-name-input" data-did="${did}" value="${escHtml(dish.name)}" placeholder="Gerichtname">
          <button class="icon-btn danger dish-delete" data-did="${did}" title="Gericht lÃ¶schen">
            <svg viewBox="0 0 24 24"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/></svg>
          </button>
        </div>
        <div class="components-row">
          ${comps.map(([cid, comp]) => buildComponentCard(cid, comp, q)).join('')}
          <div class="add-comp-col">
            <button class="btn-add-comp" data-did="${did}">
              <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
              Komponente
            </button>
          </div>
        </div>
      </div>
    `;
  }

  function buildComponentCard(cid, comp, q) {
    const ings = ingredientsOfComp(cid);
    const filtered = q ? ings.filter(([, i]) => i.name.toLowerCase().includes(q)) : ings;
    const highlight = q && filtered.length > 0;

    return `
      <div class="comp-card ${highlight ? 'highlighted' : ''}" data-cid="${cid}">
        <div class="comp-header">
          <input class="comp-name-input" data-cid="${cid}" value="${escHtml(comp.name)}" placeholder="Komponentenname">
          <button class="icon-btn danger comp-delete" data-cid="${cid}" title="Komponente lÃ¶schen">
            <svg viewBox="0 0 24 24"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/></svg>
          </button>
        </div>
        <div class="comp-meta">
          <input class="meta-input owner" data-cid="${cid}" placeholder="Verantwortlich" value="${escHtml(comp.ownerName || '')}">
          <select class="meta-select day-select" data-cid="${cid}">
            <option value="">â€” Tag â€”</option>
            ${['Di','Mi','Do'].map(d => `<option value="${d}" ${comp.prepDay===d?'selected':''}>${d}</option>`).join('')}
          </select>
          ${comp.prepDay ? `<span class="day-badge" style="background:${DAY_COLOR[comp.prepDay]}">${comp.prepDay}</span>` : ''}
        </div>
        <div class="ing-list">
          ${(q ? filtered : ings).map(([iid, ing]) => buildIngredientRow(iid, ing, q)).join('')}
        </div>
        <button class="btn-add-ing" data-cid="${cid}">
          <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          Zutat
        </button>
      </div>
    `;
  }

  function buildIngredientRow(iid, ing, q) {
    const nameHl = q && ing.name.toLowerCase().includes(q)
      ? ing.name.replace(new RegExp(q, 'gi'), m => `<mark>${m}</mark>`)
      : escHtml(ing.name);
    return `
      <div class="ing-row" data-iid="${iid}">
        <input class="ing-name" data-iid="${iid}" value="${escHtml(ing.name)}" placeholder="Zutatname">
        <input class="ing-amount" data-iid="${iid}" type="number" value="${ing.amount ?? ''}" placeholder="Menge" min="0" step="any">
        <select class="ing-unit" data-iid="${iid}">
          ${['g','kg','ml','l','Stk'].map(u => `<option ${ing.unit===u?'selected':''}>${u}</option>`).join('')}
        </select>
        <input class="ing-note" data-iid="${iid}" value="${escHtml(ing.note || '')}" placeholder="Notiz">
        <button class="icon-btn danger ing-delete" data-iid="${iid}">
          <svg viewBox="0 0 24 24"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/></svg>
        </button>
      </div>
    `;
  }

  // â”€â”€ Production Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildProduction() {
    const owners = allOwners();
    const data = productionData(prodFilterDay || null, prodFilterOwner || null);
    return `
      <div class="prod-filters">
        <select id="filter-day">
          <option value="">Alle Tage</option>
          ${['Di','Mi','Do'].map(d => `<option ${prodFilterDay===d?'selected':''}>${d}</option>`).join('')}
        </select>
        <select id="filter-owner">
          <option value="">Alle Personen</option>
          ${owners.map(o => `<option ${prodFilterOwner===o?'selected':''}>${o}</option>`).join('')}
        </select>
        <button class="btn-print" onclick="window.print()">
          <svg viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Drucken
        </button>
      </div>
      <div class="prod-board">
        ${['Di','Mi','Do'].map(day => {
          const items = data[day];
          if (!items.length && (prodFilterDay && prodFilterDay !== day)) return '';
          return `
            <div class="prod-day-col">
              <div class="prod-day-header" style="background:${DAY_COLOR[day]}">${day === 'Di' ? 'Dienstag' : day === 'Mi' ? 'Mittwoch' : 'Donnerstag'}</div>
              <div class="prod-cards">
                ${items.map(({ cid, comp, dish, ings }) => `
                  <div class="prod-card" style="border-left: 3px solid ${DAY_COLOR[comp.prepDay]}">
                    <div class="prod-card-head">
                      <strong>${escHtml(comp.name)}</strong>
                      <span class="temp-badge ${comp.warm ? 'warm' : 'kalt'}">${comp.warm ? 'warm' : 'kalt'}</span>
                    </div>
                    <div class="prod-card-sub">${dish ? escHtml(dish.name) : ''} ${comp.ownerName ? 'Â· ' + escHtml(comp.ownerName) : ''}</div>
                    <ul class="prod-ing-list">
                      ${ings.map(([, i]) => `
                        <li>
                          <span>${escHtml(i.name)}</span>
                          <span>${i.amount ? i.amount + ' ' + (i.unit||'') : ''}${i.note ? ' ('+escHtml(i.note)+')' : ''}</span>
                        </li>
                      `).join('')}
                    </ul>
                  </div>
                `).join('')}
                ${!items.length ? `<div class="empty-day">Keine EintrÃ¤ge</div>` : ''}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  // â”€â”€ Shopping Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildShopping() {
    const list = shoppingList();
    const purch = state.purchased || {};
    return `
      <div class="shop-toolbar">
        <button class="btn-primary" id="csv-export">
          <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
          CSV Export
        </button>
        <button class="btn-print" onclick="window.print()">
          <svg viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Drucken
        </button>
      </div>
      <div class="shop-table-wrap">
        <table class="shop-table">
          <thead>
            <tr>
              <th>âœ“</th>
              <th>Zutat</th>
              <th>Einheit</th>
              <th>Menge</th>
              <th>Lager</th>
              <th>Notizen</th>
            </tr>
          </thead>
          <tbody>
            ${list.map(([key, item]) => {
              const p = purch[encodeKey(key)] || {};
              return `
                <tr class="${p.bought ? 'bought' : ''}">
                  <td>
                    <button class="check-btn ${p.bought?'checked':''}" data-pkey="${encodeKey(key)}">
                      ${p.bought ? `<svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>` : ''}
                    </button>
                  </td>
                  <td class="ing-name-cell">${escHtml(item.name)}</td>
                  <td>${escHtml(item.unit)}</td>
                  <td class="amount-cell">${item.total > 0 ? item.total : 'â€”'}</td>
                  <td>
                    <input class="stock-input" data-pkey="${encodeKey(key)}" type="number" 
                      value="${p.stock ?? ''}" placeholder="â€”" min="0" step="any">
                  </td>
                  <td class="notes-cell">${escHtml([...new Set(item.notes)].join(', '))}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  function encodeKey(key) { return key.replace(/\|/g, '__').replace(/[^a-z0-9_\-]/gi, '_'); }

  function buildConfirm() {
    return `
      <div class="confirm-overlay">
        <div class="confirm-box">
          <p>${confirmPending.message}</p>
          <div class="confirm-btns">
            <button class="btn-cancel" id="confirm-cancel">Abbrechen</button>
            <button class="btn-danger" id="confirm-ok">LÃ¶schen</button>
          </div>
        </div>
      </div>
    `;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  EVENTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function attachEvents() {
    // tabs
    document.querySelectorAll(".tab").forEach(btn =>
      btn.addEventListener("click", () => { activeTab = btn.dataset.tab; render(); })
    );

    // plan
    document.getElementById("add-dish")?.addEventListener("click", () => {
      const name = prompt("Gerichtname:"); if (name?.trim()) addDish(name.trim());
    });
    document.getElementById("search")?.addEventListener("input", e => {
      searchQuery = e.target.value; render();
    });

    document.querySelectorAll(".dish-name-input").forEach(el =>
      el.addEventListener("change", e => updateDish(e.target.dataset.did, { name: e.target.value }))
    );
    document.querySelectorAll(".dish-delete").forEach(el =>
      el.addEventListener("click", e => {
        const did = e.currentTarget.dataset.did;
        const dish = state.dishes[did];
        confirmPending = {
          message: `Gericht â€${dish?.name}" wirklich lÃ¶schen? Alle Komponenten und Zutaten werden entfernt.`,
          action: async () => { await deleteDish(did); }
        };
        render();
      })
    );
    document.querySelectorAll(".btn-add-comp").forEach(el =>
      el.addEventListener("click", e => {
        const name = prompt("Komponentenname:"); if (name?.trim()) addComponent(e.currentTarget.dataset.did, name.trim());
      })
    );
    document.querySelectorAll(".comp-name-input").forEach(el =>
      el.addEventListener("change", e => updateComponent(e.target.dataset.cid, { name: e.target.value }))
    );
    document.querySelectorAll(".owner").forEach(el =>
      el.addEventListener("change", e => updateComponent(e.target.dataset.cid, { ownerName: e.target.value }))
    );
    document.querySelectorAll(".day-select").forEach(el =>
      el.addEventListener("change", e => updateComponent(e.target.dataset.cid, { prepDay: e.target.value || null }))
    );
    document.querySelectorAll(".comp-delete").forEach(el =>
      el.addEventListener("click", e => {
        const cid = e.currentTarget.dataset.cid;
        const comp = state.components[cid];
        confirmPending = {
          message: `Komponente â€${comp?.name}" wirklich lÃ¶schen? Alle Zutaten werden entfernt.`,
          action: async () => { await deleteComponent(cid); }
        };
        render();
      })
    );
    document.querySelectorAll(".btn-add-ing").forEach(el =>
      el.addEventListener("click", e => addIngredient(e.currentTarget.dataset.cid))
    );
    document.querySelectorAll(".ing-name").forEach(el =>
      el.addEventListener("change", e => updateIngredient(e.target.dataset.iid, { name: e.target.value }))
    );
    document.querySelectorAll(".ing-amount").forEach(el =>
      el.addEventListener("change", e => updateIngredient(e.target.dataset.iid, { amount: parseFloat(e.target.value) || null }))
    );
    document.querySelectorAll(".ing-unit").forEach(el =>
      el.addEventListener("change", e => updateIngredient(e.target.dataset.iid, { unit: e.target.value }))
    );
    document.querySelectorAll(".ing-note").forEach(el =>
      el.addEventListener("change", e => updateIngredient(e.target.dataset.iid, { note: e.target.value }))
    );
    document.querySelectorAll(".ing-delete").forEach(el =>
      el.addEventListener("click", e => deleteIngredient(e.currentTarget.dataset.iid))
    );

    // production filters
    document.getElementById("filter-day")?.addEventListener("change", e => { prodFilterDay = e.target.value; render(); });
    document.getElementById("filter-owner")?.addEventListener("change", e => { prodFilterOwner = e.target.value; render(); });

    // shopping
    document.querySelectorAll(".check-btn").forEach(el =>
      el.addEventListener("click", e => togglePurchased(e.currentTarget.dataset.pkey))
    );
    document.querySelectorAll(".stock-input").forEach(el =>
      el.addEventListener("change", e => updateStock(e.target.dataset.pkey, e.target.value))
    );
    document.getElementById("csv-export")?.addEventListener("click", exportCSV);

    // confirm dialog
    document.getElementById("confirm-ok")?.addEventListener("click", async () => {
      if (confirmPending?.action) await confirmPending.action();
      confirmPending = null; render();
    });
    document.getElementById("confirm-cancel")?.addEventListener("click", () => {
      confirmPending = null; render();
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CSV EXPORT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function exportCSV() {
    const list = shoppingList();
    const purch = state.purchased || {};
    const rows = [["Zutat", "Einheit", "Gesamtmenge", "Lager", "Notizen", "Gekauft"]];
    for (const [key, item] of list) {
      const p = purch[encodeKey(key)] || {};
      rows.push([
        item.name, item.unit, item.total > 0 ? item.total : '',
        p.stock ?? '', [...new Set(item.notes)].join('; '), p.bought ? 'Ja' : 'Nein'
      ]);
    }
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(";")).join("\n");
    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "einkaufsliste.csv"; a.click();
    URL.revokeObjectURL(url);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  HELPERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function escHtml(str) {
    return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function init() {
    if (DEMO_MODE) {
      const saved = lsLoad();
      state = saved || SEED;
      if (!saved) lsSave();
      render();
    } else {
      const app = initializeApp(FIREBASE_CONFIG);
      db = getDatabase(app);

      // Check if DB is empty â†’ seed
      const snap = await get(ref(db, "/"));
      if (!snap.exists()) {
        await set(ref(db, "/"), SEED);
      }

      // Live sync
      onValue(ref(db, "/"), (snapshot) => {
        state = snapshot.val() || { dishes: {}, components: {}, ingredients: {}, purchased: {} };
        render();
      });
    }
  }

  init();
</script>

<style>
  /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --accent:   #C2410C;
    --accent2:  #EA580C;
    --bg:       #FAF9F7;
    --surface:  #FFFFFF;
    --border:   #E5E2DC;
    --text:     #1C1917;
    --muted:    #78716C;
    --radius:   10px;
    --shadow:   0 1px 4px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.04);
    --font-head: 'DM Serif Display', Georgia, serif;
    --font-body: 'DM Sans', system-ui, sans-serif;
  }

  html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font-body); font-size: 14px; }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    position: sticky; top: 0; z-index: 100;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    box-shadow: 0 1px 8px rgba(0,0,0,.06);
  }
  .header-inner {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 20px 0;
  }
  .logo { font-family: var(--font-head); font-size: 22px; display: flex; align-items: center; gap: 8px; }
  .logo span { color: var(--accent); }
  .demo-badge {
    font-size: 11px; font-weight: 500; padding: 3px 10px; border-radius: 99px;
    background: #FEF3C7; color: #92400E; border: 1px solid #FDE68A;
  }
  .demo-badge.live { background: #D1FAE5; color: #065F46; border-color: #6EE7B7; }

  nav.tabs { display: flex; gap: 4px; padding: 8px 16px 0; }
  .tab {
    display: flex; align-items: center; gap: 6px;
    padding: 8px 16px; border: none; background: transparent;
    font-family: var(--font-body); font-size: 13px; font-weight: 500;
    color: var(--muted); cursor: pointer; border-radius: 8px 8px 0 0;
    border-bottom: 2px solid transparent; transition: all .15s;
  }
  .tab svg { width: 15px; height: 15px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
  .tab:hover { color: var(--text); background: var(--bg); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); background: var(--bg); }

  /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  main { padding: 24px 20px; min-height: calc(100vh - 90px); }

  /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn-primary {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 16px; background: var(--accent); color: #fff;
    border: none; border-radius: var(--radius); cursor: pointer;
    font-family: var(--font-body); font-size: 13px; font-weight: 600;
    transition: background .15s, transform .1s;
  }
  .btn-primary:hover { background: var(--accent2); }
  .btn-primary svg { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2.5; stroke-linecap: round; }
  .btn-print {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 16px; background: var(--surface); color: var(--text);
    border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer;
    font-family: var(--font-body); font-size: 13px; font-weight: 500; transition: all .15s;
  }
  .btn-print:hover { background: var(--bg); }
  .btn-print svg { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

  .icon-btn {
    display: inline-flex; align-items: center; justify-content: center;
    width: 28px; height: 28px; border: none; background: transparent;
    border-radius: 6px; cursor: pointer; color: var(--muted); transition: all .15s;
    flex-shrink: 0;
  }
  .icon-btn:hover { background: #FEE2E2; color: #DC2626; }
  .icon-btn svg { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

  /* â”€â”€ Plan Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .plan-toolbar {
    display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;
  }
  .search-wrap {
    position: relative; flex: 1; min-width: 180px;
  }
  .search-wrap svg {
    position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
    width: 15px; height: 15px; fill: none; stroke: var(--muted); stroke-width: 2; stroke-linecap: round;
    pointer-events: none;
  }
  .search-wrap input {
    width: 100%; padding: 8px 12px 8px 34px;
    border: 1px solid var(--border); border-radius: var(--radius);
    font-family: var(--font-body); font-size: 13px; background: var(--surface);
    color: var(--text); outline: none; transition: border-color .15s;
  }
  .search-wrap input:focus { border-color: var(--accent); }

  /* â”€â”€ Board â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .board { display: flex; flex-direction: column; gap: 24px; }

  .dish-block {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; overflow: hidden; box-shadow: var(--shadow);
  }
  .dish-header {
    display: flex; align-items: center; gap: 8px;
    padding: 14px 16px; background: #FDF8F5; border-bottom: 1px solid var(--border);
  }
  .chef-icon {
    width: 22px; height: 22px; flex-shrink: 0;
    fill: none; stroke: var(--accent); stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round;
  }
  .dish-name-input {
    flex: 1; border: none; background: transparent;
    font-family: var(--font-head); font-size: 19px; color: var(--text);
    outline: none; min-width: 0;
  }
  .dish-name-input:focus { color: var(--accent); }

  .components-row {
    display: flex; overflow-x: auto; padding: 16px; gap: 14px; align-items: flex-start;
    scrollbar-width: thin; scrollbar-color: var(--border) transparent;
  }

  .comp-card {
    min-width: 220px; max-width: 260px; flex-shrink: 0;
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px; transition: box-shadow .2s;
  }
  .comp-card:hover { box-shadow: 0 2px 12px rgba(0,0,0,.08); }
  .comp-card.highlighted { border-color: #FCD34D; background: #FFFBEB; }

  .comp-header {
    display: flex; align-items: center; gap: 6px; margin-bottom: 8px;
  }
  .comp-name-input {
    flex: 1; border: none; background: transparent;
    font-family: var(--font-body); font-size: 13px; font-weight: 600;
    color: var(--text); outline: none; min-width: 0;
  }
  .comp-name-input:focus { color: var(--accent); }

  .comp-meta {
    display: flex; align-items: center; gap: 6px; margin-bottom: 10px; flex-wrap: wrap;
  }
  .meta-input {
    flex: 1; min-width: 80px; padding: 4px 8px;
    border: 1px solid var(--border); border-radius: 6px;
    font-family: var(--font-body); font-size: 12px; background: var(--surface);
    color: var(--muted); outline: none;
  }
  .meta-input:focus { border-color: var(--accent); color: var(--text); }
  .meta-select {
    padding: 4px 6px; border: 1px solid var(--border); border-radius: 6px;
    font-family: var(--font-body); font-size: 12px; background: var(--surface);
    color: var(--muted); outline: none; cursor: pointer;
  }
  .meta-select:focus { border-color: var(--accent); }
  .day-badge {
    font-size: 10px; font-weight: 700; color: #fff;
    padding: 2px 7px; border-radius: 99px; flex-shrink: 0;
  }

  .ing-list { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }

  .ing-row {
    display: grid; grid-template-columns: 1fr 60px 52px 1fr 28px;
    gap: 4px; align-items: center;
  }
  .ing-row input, .ing-row select {
    padding: 4px 6px; border: 1px solid transparent;
    border-radius: 5px; font-family: var(--font-body); font-size: 12px;
    background: transparent; color: var(--text); outline: none; width: 100%;
    transition: border-color .15s, background .15s;
  }
  .ing-row input:hover, .ing-row select:hover { background: var(--surface); border-color: var(--border); }
  .ing-row input:focus, .ing-row select:focus { background: var(--surface); border-color: var(--accent); }
  .ing-amount { text-align: right; }
  .ing-note { color: var(--muted); font-style: italic; }

  .btn-add-ing, .btn-add-comp {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 5px 10px; border: 1px dashed var(--border);
    background: transparent; color: var(--muted);
    border-radius: 6px; cursor: pointer;
    font-family: var(--font-body); font-size: 12px; font-weight: 500;
    transition: all .15s; width: 100%; justify-content: center;
  }
  .btn-add-ing:hover, .btn-add-comp:hover {
    border-color: var(--accent); color: var(--accent); background: #FFF7F5;
  }
  .btn-add-ing svg, .btn-add-comp svg {
    width: 12px; height: 12px; fill: none; stroke: currentColor; stroke-width: 2.5; stroke-linecap: round;
  }

  .add-comp-col {
    min-width: 160px; display: flex; align-items: flex-start; padding-top: 2px;
  }
  .add-comp-col .btn-add-comp { border-style: dashed; min-height: 80px; }

  mark { background: #FEF08A; border-radius: 2px; padding: 0 1px; }

  /* â”€â”€ Production â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .prod-filters {
    display: flex; gap: 12px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;
  }
  .prod-filters select {
    padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius);
    font-family: var(--font-body); font-size: 13px; background: var(--surface);
    color: var(--text); outline: none; cursor: pointer;
  }
  .prod-filters select:focus { border-color: var(--accent); }

  .prod-board { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 8px; }
  .prod-day-col { min-width: 260px; flex: 1; }
  .prod-day-header {
    color: #fff; font-weight: 700; font-size: 13px; letter-spacing: .05em; text-transform: uppercase;
    padding: 8px 14px; border-radius: 8px 8px 0 0;
  }
  .prod-cards { display: flex; flex-direction: column; gap: 10px; padding-top: 10px; }

  .prod-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px; box-shadow: var(--shadow);
  }
  .prod-card-head { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .prod-card-head strong { font-size: 14px; }
  .temp-badge {
    font-size: 10px; padding: 2px 7px; border-radius: 99px; font-weight: 600;
    background: #DBEAFE; color: #1D4ED8;
  }
  .temp-badge.warm { background: #FEE2E2; color: #DC2626; }
  .prod-card-sub { font-size: 11px; color: var(--muted); margin-bottom: 8px; }
  .prod-ing-list { list-style: none; display: flex; flex-direction: column; gap: 3px; }
  .prod-ing-list li {
    display: flex; justify-content: space-between;
    font-size: 12px; padding: 2px 0; border-bottom: 1px solid var(--bg);
  }
  .prod-ing-list li span:last-child { color: var(--muted); white-space: nowrap; }
  .empty-day { font-size: 12px; color: var(--muted); font-style: italic; padding: 8px 0; }

  /* â”€â”€ Shopping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .shop-toolbar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
  .shop-table-wrap { overflow-x: auto; }
  .shop-table {
    width: 100%; border-collapse: collapse;
    background: var(--surface); border-radius: 12px; overflow: hidden;
    box-shadow: var(--shadow);
  }
  .shop-table th {
    background: #FDF8F5; font-size: 11px; font-weight: 700;
    color: var(--muted); text-transform: uppercase; letter-spacing: .06em;
    padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border);
  }
  .shop-table td {
    padding: 10px 14px; border-bottom: 1px solid var(--bg);
    font-size: 13px; vertical-align: middle;
  }
  .shop-table tr:last-child td { border-bottom: none; }
  .shop-table tr.bought td { opacity: .45; text-decoration: line-through; }
  .shop-table tr.bought .stock-input { text-decoration: none; opacity: 1; }

  .check-btn {
    width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--border);
    background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all .15s; padding: 0;
  }
  .check-btn.checked { background: var(--accent); border-color: var(--accent); }
  .check-btn svg { width: 12px; height: 12px; fill: none; stroke: #fff; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; }
  .ing-name-cell { font-weight: 500; }
  .amount-cell { font-variant-numeric: tabular-nums; font-weight: 600; color: var(--accent); }
  .notes-cell { color: var(--muted); font-style: italic; font-size: 12px; }
  .stock-input {
    width: 70px; padding: 4px 6px; border: 1px solid var(--border);
    border-radius: 6px; font-family: var(--font-body); font-size: 12px;
    background: var(--bg); color: var(--text); outline: none; text-align: right;
  }
  .stock-input:focus { border-color: var(--accent); }

  /* â”€â”€ Confirm Dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .confirm-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.4);
    display: flex; align-items: center; justify-content: center; z-index: 1000;
    backdrop-filter: blur(2px);
  }
  .confirm-box {
    background: var(--surface); border-radius: 14px; padding: 28px;
    max-width: 380px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,.2);
  }
  .confirm-box p { font-size: 15px; line-height: 1.5; margin-bottom: 20px; }
  .confirm-btns { display: flex; gap: 10px; justify-content: flex-end; }
  .btn-cancel {
    padding: 8px 18px; border: 1px solid var(--border); border-radius: 8px;
    background: var(--surface); color: var(--text);
    font-family: var(--font-body); font-size: 13px; font-weight: 500; cursor: pointer;
  }
  .btn-danger {
    padding: 8px 18px; border: none; border-radius: 8px;
    background: #DC2626; color: #fff;
    font-family: var(--font-body); font-size: 13px; font-weight: 600; cursor: pointer;
  }
  .btn-danger:hover { background: #B91C1C; }

  /* â”€â”€ Snackbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #snackbar {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: #1C1917; color: #fff; padding: 12px 20px; border-radius: 10px;
    font-size: 13px; z-index: 2000; transition: transform .3s cubic-bezier(.34,1.56,.64,1);
    white-space: nowrap; box-shadow: 0 8px 30px rgba(0,0,0,.3);
    display: flex; align-items: center; gap: 12px;
  }
  #snackbar.show { transform: translateX(-50%) translateY(0); }
  #snackbar button {
    background: var(--accent); color: #fff; border: none; padding: 4px 10px;
    border-radius: 5px; font-family: var(--font-body); font-size: 12px;
    font-weight: 600; cursor: pointer;
  }

  /* â”€â”€ Print â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media print {
    header, .plan-toolbar, .prod-filters, .shop-toolbar, .icon-btn,
    .btn-add-ing, .btn-add-comp, .btn-primary, .btn-print,
    #snackbar, .confirm-overlay { display: none !important; }
    main { padding: 0; }
    .prod-board { display: block; }
    .prod-day-col { break-inside: avoid; margin-bottom: 20px; }
    .shop-table { box-shadow: none; }
  }

  /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 600px) {
    main { padding: 16px 12px; }
    .header-inner { padding: 10px 12px 0; }
    .logo { font-size: 18px; }
    .ing-row { grid-template-columns: 1fr 52px 46px 1fr 28px; }
  }
</style>
</head>
<body>
  <div id="app">
    <div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:'DM Sans',sans-serif;color:#78716C;">
      LÃ¤dtâ€¦
    </div>
  </div>
  <div id="snackbar"></div>
</body>
</html>

<!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ANLEITUNG: Firebase einrichten (kostenlos, ~5 Minuten)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Gehe zu https://console.firebase.google.com
2. Klicke â€Projekt hinzufÃ¼gen" â†’ Namen eingeben â†’ Erstellen
3. Klicke auf â€Realtime Database" im linken MenÃ¼ â†’ â€Datenbank erstellen"
   â†’ Standort: europe-west1 â†’ Testmodus wÃ¤hlen (fÃ¼r MVP ok)
4. Klicke oben links auf â€ProjektÃ¼bersicht" â†’ das Web-Symbol </>
   â†’ App registrieren â†’ du bekommst ein firebaseConfig-Objekt
5. Ersetze die Werte im FIREBASE_CONFIG-Objekt oben in dieser Datei

DEPLOY auf GitHub Pages (ebenfalls kostenlos):
1. Erstelle ein Repository auf github.com
2. Lade diese HTML-Datei hoch (als index.html)
3. Gehe zu Repository â†’ Settings â†’ Pages â†’ Source: main branch / root
4. Deine App lÃ¤uft dann unter https://USERNAME.github.io/REPO-NAME

Alternativ: Ziehe die Datei auf https://app.netlify.com/drop (sofort online, kein Account nÃ¶tig)

SECURITY NOTE:
Im Testmodus hat jeder Lesezugriff auf deine DB. FÃ¼r eine Veranstaltung ist
das ok. Wenn du mehr Sicherheit willst, fÃ¼ge in Firebase â†’ Rules folgendes ein:
{
  "rules": {
    ".read": true,
    ".write": true
  }
}
(Testmodus macht das automatisch fÃ¼r 30 Tage.)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
